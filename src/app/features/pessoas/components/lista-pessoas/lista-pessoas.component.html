<div class="pessoas-container">
  <div class="header">
    <div class="title-group">
      <mat-icon>groups</mat-icon>
      <div>
        <h1>Pessoas</h1>
        <p>Gerencie os cadastros de pessoas utilizadas nos cursos e atividades.</p>
      </div>
    </div>
    <div class="actions">
      <button
        mat-icon-button
        type="button"
        class="info-button"
        matTooltip="Como estruturar o arquivo CSV"
        (click)="openImportHelp()">
        <mat-icon>help_outline</mat-icon>
      </button>

      <button
        mat-stroked-button
        color="primary"
        class="import-button"
        (click)="triggerImport()"
        [disabled]="!canImport() || isImporting">
        <mat-icon>file_upload</mat-icon>
        {{ isImporting ? 'Importando...' : 'Importar CSV' }}
      </button>

      <button
        mat-raised-button
        class="btn-primary add-button"
        (click)="addPessoa()"
        [disabled]="!canCreatePessoa()">
        <mat-icon>add</mat-icon>
        Nova Pessoa
      </button>

      <input
        #csvInput
        type="file"
        accept=".csv,text/csv"
        class="file-input"
        (change)="onFileSelected($event)" />
    </div>
  </div>

  <mat-card class="table-card">
    <div class="filter-row">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Buscar por nome</mat-label>
        <input matInput [formControl]="searchControl" placeholder="Digite o nome para filtrar" />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <mat-divider></mat-divider>

    <div class="import-feedback" *ngIf="lastImportResponse">
      <div class="feedback-header">
        <mat-icon color="primary">check_circle</mat-icon>
        <span>Importação concluída</span>
        <button mat-icon-button type="button" (click)="clearImportSummary()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="feedback-body">
        <p>
          <strong>Total processado:</strong> {{ lastImportResponse.totalProcessados }}<br />
          <strong>Novos cadastros:</strong> {{ lastImportResponse.totalCadastrados }}
        </p>

        <div class="feedback-lists" *ngIf="lastImportResponse.duplicados.length > 0">
          <h4>Registros ignorados</h4>
          <mat-chip-set>
            <mat-chip *ngFor="let duplicado of lastImportResponse.duplicados" color="warn" selected>
              {{ duplicado }}
            </mat-chip>
          </mat-chip-set>
        </div>
      </div>
    </div>

    <div class="table-wrapper" [class.loading]="isLoading">
      <div class="loading-container" *ngIf="isLoading">
        <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
        <span>Carregando pessoas...</span>
      </div>

      <div class="error-state" *ngIf="hasError && !isLoading">
        <mat-icon color="warn">error_outline</mat-icon>
        <p>{{ errorMessage }}</p>
        <button mat-stroked-button color="primary" (click)="loadPessoas()">Tentar novamente</button>
      </div>

      <div class="empty-state" *ngIf="!isLoading && !hasError && !hasData()">
        <mat-icon>group_off</mat-icon>
        <p>Nenhuma pessoa encontrada.</p>
        <p class="empty-hint">
          Utilize a busca para localizar cadastros ou importe um arquivo CSV.
        </p>
      </div>

      <table
        mat-table
        [dataSource]="dataSource"
        class="mat-elevation-z1"
        *ngIf="hasData()">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td mat-cell *matCellDef="let pessoa">{{ pessoa.id }}</td>
        </ng-container>

        <ng-container matColumnDef="nome">
          <th mat-header-cell *matHeaderCellDef>Nome</th>
          <td mat-cell *matCellDef="let pessoa">{{ pessoa.nome }}</td>
        </ng-container>

        <ng-container matColumnDef="usuario">
          <th mat-header-cell *matHeaderCellDef class="usuario-header">
            <span class="usuario-header-content">
              <mat-icon>person</mat-icon>
              Usuário
            </span>
          </th>
          <td mat-cell *matCellDef="let pessoa" class="usuario-cell">
            <mat-icon
              [ngClass]="getUsuarioIconClass(pessoa)"
              [matTooltip]="getUsuarioTooltip(pessoa)">
              {{ getUsuarioIcon(pessoa) }}
            </mat-icon>
          </td>
        </ng-container>

        <ng-container matColumnDef="cpf">
          <th mat-header-cell *matHeaderCellDef>CPF</th>
          <td mat-cell *matCellDef="let pessoa">{{ pessoa.cpf }}</td>
        </ng-container>

        <ng-container *ngIf="canManage()" matColumnDef="acoes">
          <th mat-header-cell *matHeaderCellDef class="actions-header">Ações</th>
          <td mat-cell *matCellDef="let pessoa" class="actions-cell">
            <button
              mat-icon-button
              color="primary"
              matTooltip="Criar usuário para esta pessoa"
              *ngIf="canCriarUsuarioParaPessoa(pessoa)"
              (click)="criarUsuarioParaPessoa(pessoa)">
              <mat-icon>person_add</mat-icon>
            </button>

            <button
              mat-icon-button
              color="primary"
              matTooltip="Editar pessoa"
              (click)="editPessoa(pessoa)"
              [disabled]="!canManage()">
              <mat-icon>edit</mat-icon>
            </button>

            <button
              mat-icon-button
              color="warn"
              matTooltip="Excluir pessoa"
              (click)="deletePessoa(pessoa)"
              [disabled]="!canManage()">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <mat-paginator
      [length]="totalElements"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[5, 10, 20, 50]"
      (page)="onPageChange($event)">
    </mat-paginator>
  </mat-card>
</div>


