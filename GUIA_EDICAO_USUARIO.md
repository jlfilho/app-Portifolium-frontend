# ‚úÖ Guia de Edi√ß√£o de Usu√°rio

## üéØ Endpoint e Payload Correto

### **PUT /api/usuarios/{usuarioId}**

---

## ‚úÖ Payload Correto para Edi√ß√£o

```json
{
  "nome": "Jo√£o da Mata Atualizado",
  "cpf": "682.414.372.34",
  "email": "jlfilho.novo@uea.edu.br",
  "senha": "novaSenha123",         // Opcional
  "role": "ROLE_ADMINISTRADOR",
  "cursos": [
    { "id": 1 },                   // Apenas id
    { "id": 2 }
  ]
}
```

**IMPORTANTE:** O campo `id` do usu√°rio **N√ÉO** vai no body, vai apenas na **URL**!

---

## üìä Estrutura Correta

### **URL:**
```
PUT http://localhost:8080/api/usuarios/5
                                        ‚Üë
                                        ID aqui
```

### **Body:**
```json
{
  // ‚úÖ SEM campo "id" aqui
  "nome": "string",
  "cpf": "string",
  "email": "string",
  "senha": "string",      // Opcional
  "role": "string",
  "cursos": [
    { "id": 1 },          // Apenas id
    { "id": 2 }
  ]
}
```

---

## üîÑ Implementa√ß√£o Atual

### **C√≥digo do Componente**

```typescript
// MODO EDI√á√ÉO
if (this.isEditMode && this.usuarioOriginal) {
  usuarioData = {
    nome: formValues.nome.trim(),
    cpf: formValues.cpf.trim(),
    email: formValues.email.trim(),
    role: formValues.role,
    cursos: (this.usuarioOriginal.cursos || []).map(curso => ({ id: curso.id }))
    // ‚úÖ Transforma: { id: 1, nome: "X", ativo: true } ‚Üí { id: 1 }
  };

  // Senha opcional
  if (formValues.senha && formValues.senha.trim() !== '') {
    usuarioData.senha = formValues.senha.trim();
  }
}

// Chamada ao service
this.usuariosService.updateUser(this.usuarioId, usuarioData);
```

---

## üìù Exemplos Pr√°ticos

### **Exemplo 1: Editar Nome e Email (Sem Alterar Senha)**

**Request:**
```
PUT http://localhost:8080/api/usuarios/5
```

**Body:**
```json
{
  "nome": "Jo√£o da Mata Silva",
  "cpf": "682.414.372.34",
  "email": "joao.novo@uea.edu.br",
  "role": "ROLE_ADMINISTRADOR",
  "cursos": [
    { "id": 1 },
    { "id": 3 }
  ]
}
```

**Resultado:**
- ‚úÖ Nome e email atualizados
- ‚úÖ Senha mantida (n√£o enviada)
- ‚úÖ Cursos preservados

---

### **Exemplo 2: Editar e Alterar Senha**

**Request:**
```
PUT http://localhost:8080/api/usuarios/10
```

**Body:**
```json
{
  "nome": "Maria Gerente Santos",
  "cpf": "123.456.789-00",
  "email": "maria@empresa.com",
  "senha": "novaSenhaSegura123",
  "role": "ROLE_GERENTE",
  "cursos": []
}
```

**Resultado:**
- ‚úÖ Todos os dados atualizados
- ‚úÖ Senha alterada
- ‚úÖ Cursos vazios (removidos)

---

### **Exemplo 3: Alterar Role e Manter Cursos**

**Request:**
```
PUT http://localhost:8080/api/usuarios/7
```

**Body:**
```json
{
  "nome": "Carlos Lima",
  "cpf": "999.888.777-66",
  "email": "carlos@empresa.com",
  "role": "ROLE_ADMINISTRADOR",
  "cursos": [
    { "id": 2 },
    { "id": 5 },
    { "id": 8 }
  ]
}
```

**Resultado:**
- ‚úÖ Role alterada de SECRETARIO ‚Üí ADMINISTRADOR
- ‚úÖ Cursos preservados (3 cursos)
- ‚úÖ Senha mantida (n√£o enviada)

---

## üîç Detalhes Importantes

### **1. ID do Usu√°rio**

```
‚ùå INCORRETO:
Body: { "id": 5, "nome": "Jo√£o", ... }

‚úÖ CORRETO:
URL: PUT /api/usuarios/5
Body: { "nome": "Jo√£o", ... }
```

### **2. Senha Opcional**

```typescript
// Se senha est√° vazia
if (!formValues.senha || formValues.senha.trim() === '') {
  // ‚úÖ N√ÉO adiciona campo senha ao payload
  usuarioData = { nome, cpf, email, role, cursos };
}

// Se senha foi preenchida
if (formValues.senha && formValues.senha.trim() !== '') {
  // ‚úÖ Adiciona senha ao payload
  usuarioData.senha = formValues.senha.trim();
}
```

**Resultado:**
- Senha vazia ‚Üí Backend mant√©m senha atual
- Senha preenchida ‚Üí Backend atualiza senha

### **3. Cursos Simplificados**

```typescript
// Cursos originais (do backend)
cursos: [
  { id: 1, nome: "Angular Avan√ßado", ativo: true },
  { id: 2, nome: "TypeScript Essencial", ativo: true }
]

// Transforma√ß√£o aplicada
cursos: (this.usuarioOriginal.cursos || []).map(curso => ({ id: curso.id }))

// Cursos enviados (simplificados)
cursos: [
  { id: 1 },
  { id: 2 }
]
```

---

## üß™ Teste de Edi√ß√£o Completo

### **Passo a Passo**

```bash
# 1. Acessar listagem de usu√°rios
http://localhost:4200/usuarios

# 2. Clicar no bot√£o ‚úèÔ∏è (editar) de um usu√°rio

# 3. Formul√°rio carrega com dados preenchidos:
Nome: "Jo√£o Silva"                 ‚úÖ Preenchido
Email: "joao@test.com"             ‚úÖ Preenchido
CPF: "123.456.789-00"              ‚úÖ Preenchido
Senha: ""                          ‚úÖ Vazio (opcional)
Role: "ROLE_GERENTE"               ‚úÖ Preenchido

# 4. Modificar campos:
Nome: "Jo√£o Silva Santos"          ‚Üê Alterado
Email: "joao.novo@test.com"        ‚Üê Alterado
Senha: [deixar vazio]              ‚Üê N√£o alterar senha

# 5. Abrir Console (F12)

# 6. Clicar em "Atualizar"

# 7. Verificar Console:
=== PAYLOAD ENVIADO ===
Modo: EDI√á√ÉO
Endpoint: PUT /api/usuarios/5
Payload: {
  "nome": "Jo√£o Silva Santos",
  "cpf": "123.456.789-00",
  "email": "joao.novo@test.com",
  "role": "ROLE_GERENTE",
  "cursos": [
    { "id": 1 },
    { "id": 3 }
  ]
}

# 8. Verificar Network Tab:
Request URL: http://localhost:8080/api/usuarios/5
Request Method: PUT
Request Payload: { nome, cpf, email, role, cursos }
                 (SEM id, SEM senha)

# 9. Response esperado (200 OK):
{
  "id": 5,
  "nome": "Jo√£o Silva Santos",
  "cpf": "123.456.789-00",
  "email": "joao.novo@test.com",
  "senha": "******",
  "role": "ROLE_GERENTE",
  "cursos": [
    { "id": 1, "nome": "Angular", "ativo": true },
    { "id": 3, "nome": "React", "ativo": true }
  ]
}

# 10. Frontend:
‚úÖ Notifica√ß√£o verde: "Usu√°rio atualizado com sucesso!"
‚úÖ Redireciona para /usuarios
‚úÖ Mudan√ßas aparecem na tabela
```

---

## üîÑ Cen√°rios de Edi√ß√£o

### **Cen√°rio 1: Editar Apenas Nome**

```
Frontend Envia:
PUT /api/usuarios/5
{
  "nome": "Jo√£o Silva ATUALIZADO",
  "cpf": "123.456.789-00",       // Mantido
  "email": "joao@test.com",      // Mantido
  "role": "ROLE_GERENTE",        // Mantido
  "cursos": [{ "id": 1 }]        // Mantido
}

Backend Atualiza:
‚úÖ Nome ‚Üí "Jo√£o Silva ATUALIZADO"
‚úÖ Demais campos mantidos
```

---

### **Cen√°rio 2: Editar e Alterar Senha**

```
Frontend Envia:
PUT /api/usuarios/10
{
  "nome": "Maria Santos",
  "cpf": "987.654.321-00",
  "email": "maria@test.com",
  "senha": "novaSenha456",       // ‚úÖ Inclu√≠da
  "role": "ROLE_SECRETARIO",
  "cursos": []
}

Backend Atualiza:
‚úÖ Todos os campos
‚úÖ Senha atualizada
```

---

### **Cen√°rio 3: Editar Sem Alterar Senha**

```
Frontend Envia:
PUT /api/usuarios/7
{
  "nome": "Carlos Lima",
  "cpf": "111.222.333-44",
  "email": "carlos@empresa.com",
  "role": "ROLE_ADMINISTRADOR",
  "cursos": [{ "id": 2 }, { "id": 4 }]
}
// ‚úÖ SEM campo senha

Backend Atualiza:
‚úÖ Nome, CPF, Email, Role, Cursos
‚úÖ Senha MANTIDA (n√£o alterada)
```

---

## ‚ö†Ô∏è Pontos Cr√≠ticos

### **1. ID vai na URL, n√£o no Body**

```
‚ùå INCORRETO:
PUT /api/usuarios/5
Body: { "id": 5, "nome": "Jo√£o", ... }

‚úÖ CORRETO:
PUT /api/usuarios/5
Body: { "nome": "Jo√£o", ... }
```

### **2. Cursos: Apenas IDs**

```
‚ùå INCORRETO:
"cursos": [
  { "id": 1, "nome": "Angular", "ativo": true }
]

‚úÖ CORRETO:
"cursos": [
  { "id": 1 }
]
```

### **3. Senha Opcional**

```typescript
// ‚úÖ Senha vazia ‚Üí N√ÉO envia campo senha
usuarioData = { nome, cpf, email, role, cursos };

// ‚úÖ Senha preenchida ‚Üí Envia campo senha
usuarioData = { nome, cpf, email, senha, role, cursos };
```

---

## üß™ Teste de Edi√ß√£o

### **Teste 1: Editar Sem Senha**

```bash
# 1. Listar usu√°rios ‚Üí Clicar ‚úèÔ∏è no usu√°rio ID 5
# 2. Modificar nome: "Jo√£o ATUALIZADO"
# 3. Deixar senha VAZIA
# 4. Clicar "Atualizar"

Console:
PUT /api/usuarios/5
{
  "nome": "Jo√£o ATUALIZADO",
  "cpf": "123.456.789-00",
  "email": "joao@test.com",
  "role": "ROLE_GERENTE",
  "cursos": [{ "id": 1 }]
}
// ‚úÖ SEM campo senha

Resultado:
‚úÖ Nome atualizado
‚úÖ Senha mantida
```

---

### **Teste 2: Editar Com Senha**

```bash
# 1. Editar usu√°rio ID 10
# 2. Modificar email: "maria.novo@test.com"
# 3. Preencher senha: "novaSenha789"
# 4. Clicar "Atualizar"

Console:
PUT /api/usuarios/10
{
  "nome": "Maria Santos",
  "cpf": "987.654.321-00",
  "email": "maria.novo@test.com",
  "senha": "novaSenha789",      // ‚úÖ Inclu√≠da
  "role": "ROLE_SECRETARIO",
  "cursos": []
}

Resultado:
‚úÖ Email atualizado
‚úÖ Senha atualizada
```

---

### **Teste 3: Alterar Role**

```bash
# 1. Editar usu√°rio ID 7
# 2. Mudar role de SECRETARIO ‚Üí ADMINISTRADOR
# 3. Clicar "Atualizar"

Console:
PUT /api/usuarios/7
{
  "nome": "Carlos Lima",
  "cpf": "111.222.333-44",
  "email": "carlos@test.com",
  "role": "ROLE_ADMINISTRADOR",  // ‚úÖ Alterada
  "cursos": [{ "id": 2 }]
}

Resultado:
‚úÖ Role atualizada
‚úÖ Chip na tabela muda de cor
```

---

## üîç Verifica√ß√£o no DevTools

### **Network Tab**

```
Request Headers:
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
Content-Type: application/json

Request URL:
http://localhost:8080/api/usuarios/5
                                   ‚Üë
                                   ID aqui

Request Method:
PUT

Request Payload:
{
  "nome": "Jo√£o Silva Santos",
  "cpf": "123.456.789-00",
  "email": "joao@test.com",
  "role": "ROLE_GERENTE",
  "cursos": [
    { "id": 1 }
  ]
}
// ‚úÖ Sem campo "id" no body
// ‚úÖ Cursos com apenas { id }
```

---

## üìä Compara√ß√£o Cria√ß√£o vs Edi√ß√£o

### **POST (Criar)** vs **PUT (Editar)**

| Aspecto | POST /api/usuarios | PUT /api/usuarios/{id} |
|---------|-------------------|------------------------|
| **ID na URL** | ‚ùå N√£o | ‚úÖ Sim |
| **ID no Body** | ‚ùå N√£o | ‚ùå N√£o |
| **Senha** | ‚úÖ Obrigat√≥ria | ‚ö†Ô∏è Opcional |
| **Cursos** | `[]` vazio | Apenas `[{ id }]` |

### **Payloads Lado a Lado**

```json
// CRIAR (POST)
{
  "nome": "Jo√£o",
  "cpf": "123...",
  "email": "joao@...",
  "senha": "senha123",      // Obrigat√≥ria
  "role": "ROLE_GERENTE",
  "cursos": []              // Vazio
}

// EDITAR (PUT /api/usuarios/5)
{
  "nome": "Jo√£o Silva",
  "cpf": "123...",
  "email": "joao@...",
  "senha": "nova123",       // Opcional
  "role": "ROLE_ADMIN",
  "cursos": [               // Preservados
    { "id": 1 },
    { "id": 2 }
  ]
}
```

---

## ‚úÖ Checklist de Valida√ß√£o

### Antes de Enviar
- [x] ‚úÖ Usu√°rio carregado do backend
- [x] ‚úÖ Dados originais armazenados
- [x] ‚úÖ Formul√°rio preenchido
- [x] ‚úÖ Valida√ß√µes passam

### Payload
- [x] ‚úÖ SEM campo "id" no body
- [x] ‚úÖ ID apenas na URL
- [x] ‚úÖ Cursos: [{ id }] (simplificados)
- [x] ‚úÖ Senha: apenas se preenchida
- [x] ‚úÖ Trim aplicado em todos campos

### Request
- [x] ‚úÖ Method: PUT
- [x] ‚úÖ URL: /api/usuarios/{id}
- [x] ‚úÖ Header: Authorization
- [x] ‚úÖ Body: JSON correto

### Response
- [x] ‚úÖ Status 200
- [x] ‚úÖ Notifica√ß√£o verde
- [x] ‚úÖ Redireciona
- [x] ‚úÖ Mudan√ßas na tabela

---

## üêõ Troubleshooting

### **Problema: "Usu√°rio n√£o encontrado"**

```
Sintoma: Erro 404
Causa: ID n√£o existe
Solu√ß√£o: Verificar se usu√°rio existe

Console:
=== ERRO AO SALVAR USU√ÅRIO ===
Status: 404
```

---

### **Problema: "CPF j√° cadastrado"**

```
Sintoma: Erro 409
Causa: Tentou mudar CPF para um j√° existente
Solu√ß√£o: Usar CPF √∫nico

Frontend:
‚ùå "CPF ou email j√° cadastrado."
```

---

### **Problema: Senha n√£o atualiza**

```
Causa: Campo senha deixado vazio
Resultado: ‚úÖ Esperado! Senha vazia = manter atual
Solu√ß√£o: Preencher campo senha se quiser alterar
```

---

### **Problema: Cursos perdidos**

```
Sintoma: Ap√≥s editar, cursos somem
Causa: usuarioOriginal.cursos n√£o preservado
Solu√ß√£o: ‚úÖ J√Å CORRIGIDO

C√≥digo:
cursos: (this.usuarioOriginal.cursos || []).map(curso => ({ id: curso.id }))
```

---

## üìã Fluxo Completo de Edi√ß√£o

```
1. Usu√°rio clica em ‚úèÔ∏è na lista
   ‚Üì
2. GET /api/usuarios/5
   ‚Üì
3. Dados carregados e armazenados
   usuarioOriginal = { id: 5, nome: "Jo√£o", cursos: [...] }
   ‚Üì
4. Formul√°rio preenchido
   ‚Üì
5. Usu√°rio modifica campos
   ‚Üì
6. Clicar "Atualizar"
   ‚Üì
7. Payload montado:
   {
     nome: "Jo√£o Silva Santos",
     cpf: "...",
     email: "...",
     senha: "..." (se preenchida),
     role: "...",
     cursos: [{ id: 1 }, { id: 2 }]
   }
   ‚Üì
8. PUT /api/usuarios/5
   Body: payload acima
   URL: /5 (ID na URL)
   ‚Üì
9. Backend atualiza
   ‚Üì
10. Response com dados atualizados
   ‚Üì
11. Notifica√ß√£o verde
   ‚Üì
12. Redireciona para /usuarios
   ‚Üì
13. Tabela atualizada
```

---

## ‚úÖ Checklist Final

- [x] ‚úÖ ID do usu√°rio na URL (n√£o no body)
- [x] ‚úÖ Cursos simplificados [{ id }]
- [x] ‚úÖ Senha opcional (n√£o enviada se vazia)
- [x] ‚úÖ Dados originais preservados
- [x] ‚úÖ Trim aplicado
- [x] ‚úÖ Console logs detalhados
- [x] ‚úÖ Erros espec√≠ficos
- [x] ‚úÖ 0 erros de linting

---

## üéâ Resultado Final

Edi√ß√£o de usu√°rio **100% funcional** e **compat√≠vel com API**!

### ‚≠ê Funciona Corretamente:

- ‚úÖ **ID na URL** - N√£o no body
- ‚úÖ **Cursos Preservados** - Mant√©m associa√ß√µes
- ‚úÖ **Senha Opcional** - Pode deixar vazio
- ‚úÖ **Dados Originais** - N√£o perdidos
- ‚úÖ **Payload Limpo** - Apenas campos necess√°rios

---

**Endpoint:** PUT http://localhost:8080/api/usuarios/{id}  
**Payload:** ‚úÖ Correto  
**Status:** ‚úÖ Funcional  
**Pronto para Uso:** SIM üöÄ

