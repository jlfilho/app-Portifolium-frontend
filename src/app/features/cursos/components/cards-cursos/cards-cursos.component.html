<div class="courses-container page-container">
  <!-- Header com título e botão adicionar -->
  <div class="app-section-header courses-header">
    <div class="app-section-header__title">
      <mat-icon>school</mat-icon>
      <div>
        <span>Meus Cursos</span>
      </div>
    </div>
    <div class="app-section-header__actions">
      <button
        mat-raised-button
        class="btn-primary add-button"
        matTooltip="Adicionar novo curso"
        matTooltipPosition="below"
        (click)="addCourse()">
        <mat-icon>add</mat-icon>
        Novo Curso
      </button>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Filtros -->
  <div class="filters-section">
    <h3 class="filters-title">
      <mat-icon>filter_list</mat-icon>
      Filtros
    </h3>

    <div class="filters-grid">
      <!-- Filtro por Nome -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Buscar por nome</mat-label>
        <input
          matInput
          [(ngModel)]="filtroNome"
          (ngModelChange)="onSearchChange($event)"
          placeholder="Digite parte do nome...">
        <mat-icon matPrefix>search</mat-icon>
        <button
          mat-icon-button
          matSuffix
          *ngIf="filtroNome"
          (click)="filtroNome = ''; onSearchChange('')"
          matTooltip="Limpar busca">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <!-- Filtro por Status -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Status do Curso</mat-label>
        <mat-select
          [(ngModel)]="filtroStatus"
          (ngModelChange)="onStatusChange()">
          <mat-option *ngFor="let status of statusOptions" [value]="status.value">
            {{ status.label }}
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>toggle_on</mat-icon>
      </mat-form-field>

      <!-- Filtro por Tipo -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Tipo de Curso</mat-label>
        <mat-select
          [(ngModel)]="filtroTipo"
          (ngModelChange)="onTipoChange()"
          [disabled]="isLoadingTipos">
          <mat-option [value]="null">Todos</mat-option>
          <mat-option *ngFor="let tc of tiposCurso" [value]="tc.id">{{ tc.nome }}</mat-option>
        </mat-select>
        <mat-icon matPrefix>category</mat-icon>
      </mat-form-field>

      <!-- Botão Limpar Filtros -->
      <button
        mat-stroked-button
        class="btn-cancel btn-clear-filters"
        (click)="limparFiltros()"
        [disabled]="isLoading || (!filtroNome && filtroStatus === null && !filtroTipo)">
        <mat-icon>clear_all</mat-icon>
        Limpar Filtros
      </button>
    </div>

    <!-- Filtros ativos -->
    <div class="active-filters" *ngIf="filtroNome || filtroStatus !== null || filtroTipo">
      <span class="filters-label">Filtros ativos:</span>
      <mat-chip-set>
        <mat-chip *ngIf="filtroNome" class="chip-default">
          <mat-icon matChipAvatar>search</mat-icon>
          Nome: "{{ filtroNome }}"
          <button matChipRemove (click)="filtroNome = ''; onSearchChange('')">
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip>
        <mat-chip *ngIf="filtroStatus !== null" class="chip-default">
          <mat-icon matChipAvatar>toggle_on</mat-icon>
          {{ filtroStatus ? 'Ativos' : 'Inativos' }}
          <button matChipRemove (click)="filtroStatus = null; onStatusChange()">
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip>
        <mat-chip *ngIf="filtroTipo !== null" class="chip-default">
          <mat-icon matChipAvatar>category</mat-icon>
          Tipo: {{ getTipoNomeById(filtroTipo) || 'Todos' }}
          <button matChipRemove (click)="filtroTipo = null; onTipoChange()">
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip>
      </mat-chip-set>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Stats row -->
  <div class="stats-row" *ngIf="!isLoading && cursos.length > 0">
    <span>Total de cursos: <strong>{{ totalElements }}</strong></span>
    <span>Exibindo: <strong>{{ cursos.length }}</strong> de <strong>{{ totalElements }}</strong></span>
  </div>

  <!-- Mensagem de erro -->
  <div *ngIf="errorMessage" class="error">
    {{ errorMessage }}
  </div>

  <!-- Loading -->
  <div class="app-loading" *ngIf="isLoading">
    <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
    <span>Carregando cursos...</span>
  </div>

  <!-- Grid de cursos -->
  @if (!isLoading && cursos.length > 0) {
    <mat-grid-list
      cols="3"
      rowHeight="420px"
      gutterSize="24px"
      class="grid-list"
      [cols]="getColumns()">
      @for (curso of cursos; track trackCurso($index, curso)) {
        <mat-grid-tile>
          <mat-card class="card" appearance="outlined" [class.card-inactive]="!curso.ativo">
            <!-- Header do Card -->
            <mat-card-header class="card-header">
              <div mat-card-avatar class="header-image"></div>
              <div class="header-text">
                <mat-card-title>{{ curso.nome }}</mat-card-title>
                <mat-chip-set class="tipo-chip-set" *ngIf="getTipoNomeFromCurso(curso)">
                  <mat-chip class="chip-highlight">{{ getTipoNomeFromCurso(curso) }}</mat-chip>
                </mat-chip-set>
              </div>
              <button
                mat-icon-button
                class="edit-button"
                matTooltip="Editar curso"
                matTooltipPosition="left"
                (click)="curso.id && editCourse(curso.id); $event.stopPropagation()">
                <mat-icon>edit</mat-icon>
              </button>
            </mat-card-header>

            <!-- Imagem do Curso -->
            <img
              class="card-image"
              mat-card-image
              [src]="getCursoImageUrl(curso)"
              alt="Imagem do curso {{ curso.nome }}"
              width="398"
              height="318"
              loading="lazy"
              (error)="onImageError($event)"
            />

            <!-- Ações do Card -->
            <mat-card-actions>
              <button
                mat-icon-button
                matTooltip="Gerenciar atividades"
                matTooltipPosition="above"
                (click)="manageAtividades(curso); $event.stopPropagation()">
                <mat-icon>hub</mat-icon>
              </button>

              <button
                mat-icon-button
                matTooltip="Gerenciar permissões"
                matTooltipPosition="above"
                (click)="managePermissions(curso); $event.stopPropagation()">
                <mat-icon>manage_accounts</mat-icon>
              </button>

              <button
                mat-icon-button
                [matTooltip]="curso.ativo ? 'Desativar curso' : 'Ativar curso'"
                matTooltipPosition="above"
                [class.status-active]="curso.ativo"
                [class.status-inactive]="!curso.ativo"
                (click)="toggleCourseStatus(curso); $event.stopPropagation()">
                <mat-icon>{{ curso.ativo ? 'visibility' : 'visibility_off' }}</mat-icon>
              </button>

              <button
                mat-icon-button
                matTooltip="Excluir curso"
                matTooltipPosition="above"
                (click)="deleteCourse(curso); $event.stopPropagation()">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </mat-grid-tile>
      }
    </mat-grid-list>

    <!-- Paginação -->
    <mat-paginator
      [length]="totalElements"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChange($event)"
      showFirstLastButtons
      class="paginator">
    </mat-paginator>
  } @else if (!isLoading) {
    <!-- Mensagem quando não há cursos -->
    <div class="app-empty-state">
      <mat-icon class="app-empty-state__icon">school</mat-icon>
      <p class="app-empty-state__title">Você não possui cursos cadastrados.</p>
      <p class="app-empty-state__subtitle">Crie seu primeiro curso para começar a gerenciar conteúdos.</p>
      <button mat-raised-button class="btn-primary add-button" (click)="addCourse()">
        <mat-icon>add</mat-icon>
        Adicionar Primeiro Curso
      </button>
    </div>
  }
</div>
